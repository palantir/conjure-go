// Copyright (c) 2018 Palantir Technologies. All rights reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

// This directory contains all of the tests that run using code generated by conjure-go. These tests are typically
// integration tests that make use of the code generated by conjure-go to verify its behavior. The generator generates
// all of the generated files that are used by these tests.

//go:generate go run $GOFILE

package main

import (
	"fmt"
	"os"

	"github.com/palantir/conjure-go/v6/conjure"
	"github.com/palantir/godel-conjure-plugin/v5/ir-gen-cli-bundler/conjureircli"
)

func main() {
	for importPath, outDir := range map[string]string{
		"auth/auth-service.yml":        "auth",
		"client/client-service.yml":    "client",
		"errors/errors.yml":            "errors",
		"objects/objects.yml":          "objects",
		"post/post-service.yml":        "post",
		"queryparam/query-service.yml": "queryparam",
		"server/server-service.yml":    "server",
	} {
		if err := run(importPath, outDir); err != nil {
			fmt.Printf("Error: %s: %+v\n", outDir, err)
			os.Exit(1)
		}
	}
}

func run(in, out string) error {
	irBytes, err := conjureircli.InputPathToIR(in)
	if err != nil {
		return err
	}
	conjureDef, err := conjure.FromIRBytes(irBytes)
	if err != nil {
		return err
	}
	return conjure.Generate(conjureDef, conjure.OutputConfiguration{OutputDir: out, GenerateServer: true, GenerateFuncsVisitor: true})
}
