// This file was generated by Conjure and should not be manually edited.

package api

import (
	"context"
	"encoding/json"
	"fmt"
	"io"
	"io/ioutil"
	"os"

	"github.com/palantir/conjure-go-runtime/v2/conjure-go-client/httpclient"
	"github.com/palantir/conjure-go-runtime/v2/conjure-go-contract/errors"
	"github.com/palantir/pkg/rid"
	werror "github.com/palantir/witchcraft-go-error"
	"github.com/palantir/witchcraft-go-logging/wlog"
	wlogzap "github.com/palantir/witchcraft-go-logging/wlog-zap"
	"github.com/palantir/witchcraft-go-logging/wlog/evtlog/evt2log"
	"github.com/palantir/witchcraft-go-logging/wlog/svclog/svc1log"
	"github.com/palantir/witchcraft-go-logging/wlog/trclog/trc1log"
	"github.com/palantir/witchcraft-go-tracing/wtracing"
	"github.com/palantir/witchcraft-go-tracing/wzipkin"
	"github.com/spf13/cobra"
	pflag "github.com/spf13/pflag"
	"gopkg.in/yaml.v3"
)

type CLIConfig struct {
	Client httpclient.ClientConfig
}

// Commands for TestService

var RootTestServiceCmd = &cobra.Command{
	Short: "Runs commands on the TestService",
	Use:   "testService",
}

func getTestServiceClient(ctx context.Context, flags *pflag.FlagSet) (TestServiceClient, error) {
	conf, err := loadConfig(ctx, flags)
	if err != nil {
		return nil, werror.WrapWithContextParams(ctx, err, "failed to load CLI configuration file")
	}
	client, err := httpclient.NewClient(httpclient.WithConfig(conf.Client))
	if err != nil {
		return nil, werror.WrapWithContextParams(ctx, err, "failed to create client with provided config")
	}
	return NewTestServiceClient(client), nil
}

var TestServiceechoCmd = &cobra.Command{
	RunE:  testServiceechoCmdRun,
	Short: "Calls the echo endpoint",
	Use:   "echo",
}

func testServiceechoCmdRun(cmd *cobra.Command, _ []string) error {
	ctx := getCLIContext()
	flags := cmd.Flags()
	client, err := getTestServiceClient(ctx, flags)
	if err != nil {
		return werror.WrapWithContextParams(ctx, err, "failed to initialize client")
	}
	return testServiceechoCmdRunInternal(ctx, flags, client)
}

func testServiceechoCmdRunInternal(ctx context.Context, flags *pflag.FlagSet, client TestServiceClient) error {
	var err error

	err = client.Echo(ctx)
	return err
}

var TestServicepathParamCmd = &cobra.Command{
	RunE:  testServicepathParamCmdRun,
	Short: "Calls the pathParam endpoint",
	Use:   "pathParam",
}

func testServicepathParamCmdRun(cmd *cobra.Command, _ []string) error {
	ctx := getCLIContext()
	flags := cmd.Flags()
	client, err := getTestServiceClient(ctx, flags)
	if err != nil {
		return werror.WrapWithContextParams(ctx, err, "failed to initialize client")
	}
	return testServicepathParamCmdRunInternal(ctx, flags, client)
}

func testServicepathParamCmdRunInternal(ctx context.Context, flags *pflag.FlagSet, client TestServiceClient) error {
	var err error

	paramRaw, err := flags.GetString("param")
	if err != nil {
		return werror.WrapWithContextParams(ctx, err, "failed to parse argument param")
	}
	if paramRaw == "" {
		return werror.ErrorWithContextParams(ctx, "paramArg is a required argument")
	}
	paramArg := paramRaw

	err = client.PathParam(ctx, paramArg)
	return err
}

var TestServicepathParamAliasCmd = &cobra.Command{
	RunE:  testServicepathParamAliasCmdRun,
	Short: "Calls the pathParamAlias endpoint",
	Use:   "pathParamAlias",
}

func testServicepathParamAliasCmdRun(cmd *cobra.Command, _ []string) error {
	ctx := getCLIContext()
	flags := cmd.Flags()
	client, err := getTestServiceClient(ctx, flags)
	if err != nil {
		return werror.WrapWithContextParams(ctx, err, "failed to initialize client")
	}
	return testServicepathParamAliasCmdRunInternal(ctx, flags, client)
}

func testServicepathParamAliasCmdRunInternal(ctx context.Context, flags *pflag.FlagSet, client TestServiceClient) error {
	var err error

	paramRaw, err := flags.GetString("param")
	if err != nil {
		return werror.WrapWithContextParams(ctx, err, "failed to parse argument param")
	}
	if paramRaw == "" {
		return werror.ErrorWithContextParams(ctx, "paramArg is a required argument")
	}
	paramArg := StringAlias(paramRaw)

	err = client.PathParamAlias(ctx, paramArg)
	return err
}

var TestServicepathParamRidCmd = &cobra.Command{
	RunE:  testServicepathParamRidCmdRun,
	Short: "Calls the pathParamRid endpoint",
	Use:   "pathParamRid",
}

func testServicepathParamRidCmdRun(cmd *cobra.Command, _ []string) error {
	ctx := getCLIContext()
	flags := cmd.Flags()
	client, err := getTestServiceClient(ctx, flags)
	if err != nil {
		return werror.WrapWithContextParams(ctx, err, "failed to initialize client")
	}
	return testServicepathParamRidCmdRunInternal(ctx, flags, client)
}

func testServicepathParamRidCmdRunInternal(ctx context.Context, flags *pflag.FlagSet, client TestServiceClient) error {
	var err error

	paramRaw, err := flags.GetString("param")
	if err != nil {
		return werror.WrapWithContextParams(ctx, err, "failed to parse argument param")
	}
	if paramRaw == "" {
		return werror.ErrorWithContextParams(ctx, "paramArg is a required argument")
	}
	paramArg, err := rid.ParseRID(paramRaw)
	if err != nil {
		return werror.WrapWithContextParams(ctx, errors.WrapWithInvalidArgument(err), "failed to parse \"param\" as rid")
	}

	err = client.PathParamRid(ctx, paramArg)
	return err
}

var TestServicepathParamRidAliasCmd = &cobra.Command{
	RunE:  testServicepathParamRidAliasCmdRun,
	Short: "Calls the pathParamRidAlias endpoint",
	Use:   "pathParamRidAlias",
}

func testServicepathParamRidAliasCmdRun(cmd *cobra.Command, _ []string) error {
	ctx := getCLIContext()
	flags := cmd.Flags()
	client, err := getTestServiceClient(ctx, flags)
	if err != nil {
		return werror.WrapWithContextParams(ctx, err, "failed to initialize client")
	}
	return testServicepathParamRidAliasCmdRunInternal(ctx, flags, client)
}

func testServicepathParamRidAliasCmdRunInternal(ctx context.Context, flags *pflag.FlagSet, client TestServiceClient) error {
	var err error

	paramRaw, err := flags.GetString("param")
	if err != nil {
		return werror.WrapWithContextParams(ctx, err, "failed to parse argument param")
	}
	if paramRaw == "" {
		return werror.ErrorWithContextParams(ctx, "paramArg is a required argument")
	}
	paramArgValue, err := rid.ParseRID(paramRaw)
	if err != nil {
		return werror.WrapWithContextParams(ctx, errors.WrapWithInvalidArgument(err), "failed to parse \"param\" as rid")
	}
	paramArg := RidAlias(paramArgValue)

	err = client.PathParamRidAlias(ctx, paramArg)
	return err
}

var TestServicebytesCmd = &cobra.Command{
	RunE:  testServicebytesCmdRun,
	Short: "Calls the bytes endpoint",
	Use:   "bytes",
}

func testServicebytesCmdRun(cmd *cobra.Command, _ []string) error {
	ctx := getCLIContext()
	flags := cmd.Flags()
	client, err := getTestServiceClient(ctx, flags)
	if err != nil {
		return werror.WrapWithContextParams(ctx, err, "failed to initialize client")
	}
	return testServicebytesCmdRunInternal(ctx, flags, client)
}

func testServicebytesCmdRunInternal(ctx context.Context, flags *pflag.FlagSet, client TestServiceClient) error {
	var err error

	result, err := client.Bytes(ctx)
	if err != nil {
		return err
	}
	resultBytes, err := json.MarshalIndent(result, "", "    ")
	if err != nil {
		fmt.Printf("Failed to marshal to json with err: %v\n\nPrinting as string:\n%v\n", err, result)
		return nil
	}
	fmt.Printf("%v\n", string(resultBytes))
	return nil
}

var TestServicebinaryCmd = &cobra.Command{
	RunE:  testServicebinaryCmdRun,
	Short: "Calls the binary endpoint",
	Use:   "binary",
}

func testServicebinaryCmdRun(cmd *cobra.Command, _ []string) error {
	ctx := getCLIContext()
	flags := cmd.Flags()
	client, err := getTestServiceClient(ctx, flags)
	if err != nil {
		return werror.WrapWithContextParams(ctx, err, "failed to initialize client")
	}
	return testServicebinaryCmdRunInternal(ctx, flags, client)
}

func testServicebinaryCmdRunInternal(ctx context.Context, flags *pflag.FlagSet, client TestServiceClient) error {
	var err error

	result, err := client.Binary(ctx)
	if err != nil {
		return err
	}
	_, err = io.Copy(os.Stdout, result)
	if err != nil {
		return werror.WrapWithContextParams(ctx, err, "failed to write result bytes to stdout")
	}
	return result.Close()
}

var TestServicemaybeBinaryCmd = &cobra.Command{
	RunE:  testServicemaybeBinaryCmdRun,
	Short: "Calls the maybeBinary endpoint",
	Use:   "maybeBinary",
}

func testServicemaybeBinaryCmdRun(cmd *cobra.Command, _ []string) error {
	ctx := getCLIContext()
	flags := cmd.Flags()
	client, err := getTestServiceClient(ctx, flags)
	if err != nil {
		return werror.WrapWithContextParams(ctx, err, "failed to initialize client")
	}
	return testServicemaybeBinaryCmdRunInternal(ctx, flags, client)
}

func testServicemaybeBinaryCmdRunInternal(ctx context.Context, flags *pflag.FlagSet, client TestServiceClient) error {
	var err error

	result, err := client.MaybeBinary(ctx)
	if err != nil {
		return err
	}
	if result == nil {
		return nil
	}
	resultDeref := *result
	_, err = io.Copy(os.Stdout, resultDeref)
	if err != nil {
		return werror.WrapWithContextParams(ctx, err, "failed to write result bytes to stdout")
	}
	return resultDeref.Close()
}

var TestServicequeryCmd = &cobra.Command{
	RunE:  testServicequeryCmdRun,
	Short: "Calls the query endpoint",
	Use:   "query",
}

func testServicequeryCmdRun(cmd *cobra.Command, _ []string) error {
	ctx := getCLIContext()
	flags := cmd.Flags()
	client, err := getTestServiceClient(ctx, flags)
	if err != nil {
		return werror.WrapWithContextParams(ctx, err, "failed to initialize client")
	}
	return testServicequeryCmdRunInternal(ctx, flags, client)
}

func testServicequeryCmdRunInternal(ctx context.Context, flags *pflag.FlagSet, client TestServiceClient) error {
	var err error

	queryRaw, err := flags.GetString("query")
	if err != nil {
		return werror.WrapWithContextParams(ctx, err, "failed to parse argument query")
	}
	var queryArg *StringAlias
	if queryArgStr := queryRaw; queryArgStr != "" {
		queryArgInternal := StringAlias(queryArgStr)
		queryArg = &queryArgInternal
	}

	err = client.Query(ctx, queryArg)
	return err
}

func loadConfig(ctx context.Context, flags *pflag.FlagSet) (CLIConfig, error) {
	var emptyConfig CLIConfig
	configPath, err := flags.GetString("conf")
	if err != nil || configPath == "" {
		return emptyConfig, werror.WrapWithContextParams(ctx, err, "config file location must be specified")
	}
	confBytes, err := ioutil.ReadFile(configPath)
	if err != nil {
		return emptyConfig, err
	}
	var conf CLIConfig
	err = yaml.Unmarshal(confBytes, &conf)
	if err != nil {
		return emptyConfig, err
	}
	return conf, nil
}

func getCLIContext() context.Context {
	ctx := context.Background()
	wlog.SetDefaultLoggerProvider(wlogzap.LoggerProvider())
	ctx = svc1log.WithLogger(ctx, svc1log.New(os.Stdout, wlog.DebugLevel))
	traceLogger := trc1log.DefaultLogger()
	ctx = trc1log.WithLogger(ctx, traceLogger)
	ctx = evt2log.WithLogger(ctx, evt2log.New(os.Stdout))
	tracer, err := wzipkin.NewTracer(traceLogger)
	if err != nil {
		return ctx
	}
	return wtracing.ContextWithTracer(ctx, tracer)
}

func RegisterCommands(rootCmd *cobra.Command) {
	rootCmd.AddCommand(RootTestServiceCmd)
}

func init() {
	// TestService commands and flags
	RootTestServiceCmd.PersistentFlags().String("conf", "../var/conf/configuration.yml", "The configuration file is optional. The default path is ./var/conf/configuration.yml.")
	RootTestServiceCmd.AddCommand(TestServiceechoCmd)
	RootTestServiceCmd.AddCommand(TestServicepathParamCmd)
	TestServicepathParamCmd.Flags().String("param", "", "param is a required param.")
	RootTestServiceCmd.AddCommand(TestServicepathParamAliasCmd)
	TestServicepathParamAliasCmd.Flags().String("param", "", "param is a required param.")
	RootTestServiceCmd.AddCommand(TestServicepathParamRidCmd)
	TestServicepathParamRidCmd.Flags().String("param", "", "param is a required param.")
	RootTestServiceCmd.AddCommand(TestServicepathParamRidAliasCmd)
	TestServicepathParamRidAliasCmd.Flags().String("param", "", "param is a required param.")
	RootTestServiceCmd.AddCommand(TestServicebytesCmd)
	RootTestServiceCmd.AddCommand(TestServicebinaryCmd)
	RootTestServiceCmd.AddCommand(TestServicemaybeBinaryCmd)
	RootTestServiceCmd.AddCommand(TestServicequeryCmd)
	TestServicequeryCmd.Flags().String("query", "", "query is an optional param.")
}
